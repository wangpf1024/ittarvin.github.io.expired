---
layout: post
subtitle: 《操作系统》7小节： 中断处理，时钟管理
tags: [操作系统]
comments: false
cover-img: /assets/img/IMG_1753.JPG
thumbnail-img: /assets/img/操作系统概论.jpeg
share-img: /assets/img/IMG_1482.JPG
---

一般操作系统内核包括，支撑功能，资源管理功能。支撑功能包括：中断处理，时钟管理，原语操作。

# 操作系统

##  操作系统内核
中断是改变处理器执行命令顺序的一种事件，这样的事件与CPU芯片内外部硬件电路产生的点信号相对应。

### 为什么需要中断？
1. 引入中断机制后，使CPU可以与其它设备并行工作，能够有效提高CPU的利用率。改善系统性能，支持系统的异步性。

引入中断处理机制后的，打印服务进程与其它进程的并发执行工程情况如下图，打印机准备过程中，CPU与打印机是并行工作的。

![操作系统-中断-工作情况.png](/assets/img/操作系统-中断-工作情况.png){: .mx-auto.d-block :}

### 中断的类型

1. 同步中断（内部中断）。
同步中断是由CPU控制单元产生的，之所以称为同步，是因为只有在一条指令终止执行后CPU才会发起中断，如除法出错，调试，溢出，浮点出错等。

2. 异步中断（外部中断）。
异步中断是有其它硬件设备随机产生的，外部中断又可分为“外部可屏蔽中断”和“外部不可屏蔽中断”。

### 引起中断的原因
1. 人为设置中断。
2. 程序故障。
3. 硬件故障。
4. I/O设备。
5. 外部事件。

### 中断响应
1. 响应中断的条件。
对于可屏蔽中断，开中断是响应中断的前提。

2. 响应中断的时机。
对于外部中断，CPU每执行完一条指令都会检查是否有外部中断信号的到来。若有，则转中断处理程序过程。

### 单重中断的处理过程
假定限制条件：
1. 中断处理过程中不再响应新进产生的中断信息，直到本次中断处理完成。
2. 中断处理完毕后，CPU返回被中断的程序断点处继续执行被中断程序。

执行过程：
1. 系统关中断（响应中断），保护断点，把当前要执行的下一条指令的地址保存的内存中，便于中断返回时，能把这个地址恢复到[程序计数器PC](/2022-07-05-Operating-System-进程概念.md)中，使被中断的程序从断点处继续执行。
2. 转中断处理程序。在中断处理程序中完成保护现场的工作，就是把相关硬件上下文信息保存到内存中。硬件上下文就是中断返回恢复被中断程序执行时，需要写回CPU寄存器的值。
3. 保护现场后，要根据中断向量到中断向量表中找到与中断处理子例程入口地址相关的信息，由这些信息得到中断处理子例的入口地址，以执行中断处理子例程，完成本次中断处理的特点处理工作。
4. 最后 ，恢复现场，开中断，CPU返回断点处继续执行被中断的程序。
![操作系统-中断-单重中断.png](/assets/img/操作系统-中断-单重中断.png){: .mx-auto.d-block :}

### 计算机系统中的时钟
大部分PC有两个时钟源，分为称为实时时钟（RTC或CMOS）和 OS 时钟。

CMOS：一块时钟芯片，靠电池供电，为计算机提供记时标准，最原始，最底层的数据。
OS：产于 PC 主板上的定时/计数芯片，在开机时有效，有操作系统控制。

### CMOS，OS，应用程序关系
计算机开机加电后，操作系统通BIOS获取当前RTC时钟的值作为系统初始时间，操作系统初始化后启用自己的时钟硬件，即可编程定时器（Programmable Internal Timer）PIT。
PIT 可以按照一定频率产生时钟中断，以告知内核又一个时间间隔过去了。
![操作系统-内核-时钟.png](/assets/img/操作系统-内核-时钟.png){: .mx-auto.d-block :}
### 操作系统的时钟机制
操作系统内核需要完成两种的定时测量：
1. 保存当前的日期和时间，以便于通过系统调用把它们返回给用户程序，让用户程序获取当前的日期和时间，也可有系统内核本身吧当前时间作为文件和网络包的时间戳。
2. 维持定时器，这种机制能够告诉内核或用户程序某一时间间隔已经过去了。

操作系统主要依靠时钟硬件（PIT）和时钟驱动程序完成上述两种测量。

1. OS 时钟的管理硬件（PIT）
可编程间隔定时器的功能是按指定的时间间隔产生时钟中断，测量过去的时间，并触发与时间有关的操作。
主要组成部分包括：晶振，计数器，保持寄存器。

晶振能够产生固定频率的脉冲，每产生一次脉冲，计数器的值减1，当计数器的值为0时，产生一次时钟中断信号，保持寄存器的值再次送入计数器。由可编程间隔定时器（PIT）产生中断信号送到可编程中断控制器（PIC）的时钟中断信号引脚。

可编程定时器产生的时钟中断过程如图：

![操作系统-内核-时钟中断信号.png](/assets/img/操作系统-内核-时钟中断信号.png){: .mx-auto.d-block :}

2. 时钟软件（时钟驱动程序）
时钟驱动程序也称为时钟中断处理程序，每产生一次时钟中断信号，操作系统内核要执行时钟驱动程序，时钟驱动程序完成的功能包括：
1. 维护日期和时间。
2. 递减当前进程在一个时间片内的剩余执行时间，并检查是否为0，防止程序超时运行。
3. 对CPU的使用记账。
4. 递减报警计数器。



