---
layout: post
subtitle: 《操作系统》 21小节： 分页的虚拟存储
tags: [操作系统]
comments: false
cover-img: /assets/img/IMG_1753.JPG
thumbnail-img: /assets/img/操作系统概论.jpeg
share-img: /assets/img/IMG_1482.JPG
---

虚拟存储技术实现的基本思想是，只是把进程的一部分装入内存中。进程执行过程中，CPU 访问内存时如果发现所访问的内容不在内存中，则通过异常处理将所需要的内容从外存调入内存。也就是说将进程所需的一部分装入内存，其余部分什么时候需要，什么时候请求系统调入。


# 操作系统

##  内存管理

**虚拟存储技术3点好处**

1. 提高内存利用率。
> 因为虚拟存储技术允许只把进程的一部分装入内存，原则上尽量把必须，常用的部分装入内存。

2. 提高多道程序度。
> 因为只把每一个进程的一部分装入内存，因此可以在内存装入更多的进程。

3. 把逻辑地址空间和物理空间分开，时程序员不用关心物理内存容量对内存的限制。

**虚拟存储系统具有以下几个特点**

1. 离散性
> 离散性是指进程可以分散地存储在物理内存中。分页，分段，段页式存储都属于离散的内存管理方式。_离散性是实现虚拟存储管理的基础_。

2. 多次性
> 多次性是指不必要把进程一次性全部装入内存，可以先将进程当前所必要的代码和数据装入内存中，其余部分等进程运行需要时候再装入。可将进程分多次装入内存。

3. 对调性
> 对调性是指在内存中的进程可以换出，以腾出内存空间换入外存中的进程。为了提供内存的利用率，为程序员提供足够大的内存虚拟空间，在进程运行期间，系统可以将内存中暂时不用的程序代码或数据换出到外存中，以后有需要这些程序和代码再由系统掉入内存。

4. 虚拟性
> 虚拟性是指虚拟存储系统为用户提供了比实际物理空间内存大多的逻辑内存空间，是程序员不必在编程时受到物理内存空间大小的限制。_虚拟性是实现虚拟存储系统的重要目标_。

### 请求分页中的硬件支持

**页表**

页表是支持请求分页系统最重要的数据结构，其作用是记录描述页的各种数据，包括在实现逻辑地址到物理地址是需要的页号和页框号的对应关系。除了页号和页框号之外，页表中还增加了请求换入，和页置换时候需要的数据。

|  页框号 |  状态位P |   访问字段A| 修改位M  | 保护位  |


页框号
> 存放页所在的页框号

状态位P
> 用来标识页是否在内存中

访问字段A
> 用于记录页最近被访问的情况

修改位M
> 用于标记页最近释放被修改过

保护位
> 用于标识页的访问权限


**缺页异常机构**

> 缺页异常机构的主要作用是在访问内存过程中发现缺页时产生缺页异常信号，使cpu中断当前控制流的执行，转去执行操作系统的缺页异常处理程序，完成请求调页。

请求过程：

1. 分页硬件通过页表完成逻辑地址到物理地址的映射时，通过检测页表中的**状态位P**。判断当前被访问的页是否在内存中。如果不在内存中则产生缺页异常信号。
2. 执行操作的系统的缺页异常处理过程。先在内存中为请求调用的页找一个空闲页框。然后，调度磁盘操作，包需要的页装入找到的空闲页框中。
3. 需改页表，更新已经调入页的**存在位**，在内存中的页框号，访问位，和保护位等字段值。
4. 重新开始执行缺页异常而被中断的指令。

**地址变换**

> 请求分页中的地址变换过程如下：

1. 由分页地址变换机构从逻辑地址中分离出页号和页内偏移量。
2. 以页号位索引查找快表，若快表中有该页的页表项，则读出页框号，计算物理地址。
3. 若快表中无该页表信息，转到内存表中查找。若干页表中的状态位P显示该页已调入内存，则从相应的页表项读出页所在的页框号，并计算物理地址，然后把该页表项写入快表。  
4. 若该页尚未调用内存，_则产生缺页异常_，请求操作系统从外存把该页掉入内存，然后需改页表，重新执行被中断的指令。


